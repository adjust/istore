BEGIN;
SET max_parallel_workers_per_gather=4;
SET force_parallel_mode=on;
CREATE EXTENSION istore;
CREATE TABLE test(data istore, bigdata bigistore) WITH (parallel_workers = 4);
INSERT INTO test(data, bigdata)
SELECT istore(array_agg(i), array_agg(i+10*j)), bigistore(array_agg(i), array_agg(i+10*j))
FROM generate_series(1,10) i, generate_series(0,99999) j GROUP BY j;
--check that parallization is used
EXPLAIN (costs off,verbose)
SELECT min(data), max(data), sum(data), min(bigdata), max(bigdata), sum(bigdata)
FROM test;
                                                                      QUERY PLAN                                                                       
-------------------------------------------------------------------------------------------------------------------------------------------------------
 Finalize Aggregate
   Output: min(data), max(data), sum(data), min(bigdata), max(bigdata), sum(bigdata)
   ->  Gather
         Output: (PARTIAL min(data)), (PARTIAL max(data)), (PARTIAL sum(data)), (PARTIAL min(bigdata)), (PARTIAL max(bigdata)), (PARTIAL sum(bigdata))
         Workers Planned: 4
         ->  Partial Aggregate
               Output: PARTIAL min(data), PARTIAL max(data), PARTIAL sum(data), PARTIAL min(bigdata), PARTIAL max(bigdata), PARTIAL sum(bigdata)
               ->  Parallel Seq Scan on public.test
                     Output: data, bigdata
(9 rows)

--compare results
\x on
-- non parallel
SET max_parallel_workers_per_gather=0;
SET force_parallel_mode=on;
SELECT min(data), max(data), sum(data), min(bigdata), max(bigdata), sum(bigdata)
FROM test;
-[ RECORD 1 ]------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
min | "1"=>"1", "2"=>"2", "3"=>"3", "4"=>"4", "5"=>"5", "6"=>"6", "7"=>"7", "8"=>"8", "9"=>"9", "10"=>"10"
max | "1"=>"999991", "2"=>"999992", "3"=>"999993", "4"=>"999994", "5"=>"999995", "6"=>"999996", "7"=>"999997", "8"=>"999998", "9"=>"999999", "10"=>"1000000"
sum | "1"=>"49999600000", "2"=>"49999700000", "3"=>"49999800000", "4"=>"49999900000", "5"=>"50000000000", "6"=>"50000100000", "7"=>"50000200000", "8"=>"50000300000", "9"=>"50000400000", "10"=>"50000500000"
min | "1"=>"1", "2"=>"2", "3"=>"3", "4"=>"4", "5"=>"5", "6"=>"6", "7"=>"7", "8"=>"8", "9"=>"9", "10"=>"10"
max | "1"=>"999991", "2"=>"999992", "3"=>"999993", "4"=>"999994", "5"=>"999995", "6"=>"999996", "7"=>"999997", "8"=>"999998", "9"=>"999999", "10"=>"1000000"
sum | "1"=>"49999600000", "2"=>"49999700000", "3"=>"49999800000", "4"=>"49999900000", "5"=>"50000000000", "6"=>"50000100000", "7"=>"50000200000", "8"=>"50000300000", "9"=>"50000400000", "10"=>"50000500000"

-- single gather
SET max_parallel_workers_per_gather=1;
SET force_parallel_mode=on;
SELECT min(data), max(data), sum(data), min(bigdata), max(bigdata), sum(bigdata)
FROM test;
-[ RECORD 1 ]------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
min | "1"=>"1", "2"=>"2", "3"=>"3", "4"=>"4", "5"=>"5", "6"=>"6", "7"=>"7", "8"=>"8", "9"=>"9", "10"=>"10"
max | "1"=>"999991", "2"=>"999992", "3"=>"999993", "4"=>"999994", "5"=>"999995", "6"=>"999996", "7"=>"999997", "8"=>"999998", "9"=>"999999", "10"=>"1000000"
sum | "1"=>"49999600000", "2"=>"49999700000", "3"=>"49999800000", "4"=>"49999900000", "5"=>"50000000000", "6"=>"50000100000", "7"=>"50000200000", "8"=>"50000300000", "9"=>"50000400000", "10"=>"50000500000"
min | "1"=>"1", "2"=>"2", "3"=>"3", "4"=>"4", "5"=>"5", "6"=>"6", "7"=>"7", "8"=>"8", "9"=>"9", "10"=>"10"
max | "1"=>"999991", "2"=>"999992", "3"=>"999993", "4"=>"999994", "5"=>"999995", "6"=>"999996", "7"=>"999997", "8"=>"999998", "9"=>"999999", "10"=>"1000000"
sum | "1"=>"49999600000", "2"=>"49999700000", "3"=>"49999800000", "4"=>"49999900000", "5"=>"50000000000", "6"=>"50000100000", "7"=>"50000200000", "8"=>"50000300000", "9"=>"50000400000", "10"=>"50000500000"

SET max_parallel_workers_per_gather=2;
SET force_parallel_mode=on;
SELECT min(data), max(data), sum(data), min(bigdata), max(bigdata), sum(bigdata)
FROM test;
-[ RECORD 1 ]------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
min | "1"=>"1", "2"=>"2", "3"=>"3", "4"=>"4", "5"=>"5", "6"=>"6", "7"=>"7", "8"=>"8", "9"=>"9", "10"=>"10"
max | "1"=>"999991", "2"=>"999992", "3"=>"999993", "4"=>"999994", "5"=>"999995", "6"=>"999996", "7"=>"999997", "8"=>"999998", "9"=>"999999", "10"=>"1000000"
sum | "1"=>"49999600000", "2"=>"49999700000", "3"=>"49999800000", "4"=>"49999900000", "5"=>"50000000000", "6"=>"50000100000", "7"=>"50000200000", "8"=>"50000300000", "9"=>"50000400000", "10"=>"50000500000"
min | "1"=>"1", "2"=>"2", "3"=>"3", "4"=>"4", "5"=>"5", "6"=>"6", "7"=>"7", "8"=>"8", "9"=>"9", "10"=>"10"
max | "1"=>"999991", "2"=>"999992", "3"=>"999993", "4"=>"999994", "5"=>"999995", "6"=>"999996", "7"=>"999997", "8"=>"999998", "9"=>"999999", "10"=>"1000000"
sum | "1"=>"49999600000", "2"=>"49999700000", "3"=>"49999800000", "4"=>"49999900000", "5"=>"50000000000", "6"=>"50000100000", "7"=>"50000200000", "8"=>"50000300000", "9"=>"50000400000", "10"=>"50000500000"

-- max gather
SET max_parallel_workers_per_gather=4;
SET force_parallel_mode=on;
SELECT min(data), max(data), sum(data), min(bigdata), max(bigdata), sum(bigdata)
FROM test;
-[ RECORD 1 ]------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
min | "1"=>"1", "2"=>"2", "3"=>"3", "4"=>"4", "5"=>"5", "6"=>"6", "7"=>"7", "8"=>"8", "9"=>"9", "10"=>"10"
max | "1"=>"999991", "2"=>"999992", "3"=>"999993", "4"=>"999994", "5"=>"999995", "6"=>"999996", "7"=>"999997", "8"=>"999998", "9"=>"999999", "10"=>"1000000"
sum | "1"=>"49999600000", "2"=>"49999700000", "3"=>"49999800000", "4"=>"49999900000", "5"=>"50000000000", "6"=>"50000100000", "7"=>"50000200000", "8"=>"50000300000", "9"=>"50000400000", "10"=>"50000500000"
min | "1"=>"1", "2"=>"2", "3"=>"3", "4"=>"4", "5"=>"5", "6"=>"6", "7"=>"7", "8"=>"8", "9"=>"9", "10"=>"10"
max | "1"=>"999991", "2"=>"999992", "3"=>"999993", "4"=>"999994", "5"=>"999995", "6"=>"999996", "7"=>"999997", "8"=>"999998", "9"=>"999999", "10"=>"1000000"
sum | "1"=>"49999600000", "2"=>"49999700000", "3"=>"49999800000", "4"=>"49999900000", "5"=>"50000000000", "6"=>"50000100000", "7"=>"50000200000", "8"=>"50000300000", "9"=>"50000400000", "10"=>"50000500000"

CREATE TABLE paralllel_out AS
SELECT
min(data) as min_data, max(data) as max_data, sum(data) as sum_data,
min(bigdata) as min_bigdata, max(bigdata) as max_bigdata, sum(bigdata) as sum_bigdata
FROM test;
\d paralllel_out
    Table "public.paralllel_out"
   Column    |   Type    | Modifiers 
-------------+-----------+-----------
 min_data    | istore    | 
 max_data    | istore    | 
 sum_data    | bigistore | 
 min_bigdata | bigistore | 
 max_bigdata | bigistore | 
 sum_bigdata | bigistore | 

SELECT * FROM paralllel_out;
-[ RECORD 1 ]--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
min_data    | "1"=>"1", "2"=>"2", "3"=>"3", "4"=>"4", "5"=>"5", "6"=>"6", "7"=>"7", "8"=>"8", "9"=>"9", "10"=>"10"
max_data    | "1"=>"999991", "2"=>"999992", "3"=>"999993", "4"=>"999994", "5"=>"999995", "6"=>"999996", "7"=>"999997", "8"=>"999998", "9"=>"999999", "10"=>"1000000"
sum_data    | "1"=>"49999600000", "2"=>"49999700000", "3"=>"49999800000", "4"=>"49999900000", "5"=>"50000000000", "6"=>"50000100000", "7"=>"50000200000", "8"=>"50000300000", "9"=>"50000400000", "10"=>"50000500000"
min_bigdata | "1"=>"1", "2"=>"2", "3"=>"3", "4"=>"4", "5"=>"5", "6"=>"6", "7"=>"7", "8"=>"8", "9"=>"9", "10"=>"10"
max_bigdata | "1"=>"999991", "2"=>"999992", "3"=>"999993", "4"=>"999994", "5"=>"999995", "6"=>"999996", "7"=>"999997", "8"=>"999998", "9"=>"999999", "10"=>"1000000"
sum_bigdata | "1"=>"49999600000", "2"=>"49999700000", "3"=>"49999800000", "4"=>"49999900000", "5"=>"50000000000", "6"=>"50000100000", "7"=>"50000200000", "8"=>"50000300000", "9"=>"50000400000", "10"=>"50000500000"

ROLLBACK;
